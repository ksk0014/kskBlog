---
title: 分布式系统部署工具
tags:
  - Tools
type: categories
categories:
  - 部署工具
copyright: true
date: 2018-05-05 19:05:53
---


# 背景 #
分布式集群搭建通常具体以下几个难点:  

- 具有复杂的机器拓扑结构
- 配置管理错综复杂
- 模块之间的启动顺序有着强依赖
- 模块版本变更由于跨机器十分不便
- 集群外部系统依赖复杂且难以管理

对于一套可以**简洁易用**的中控式搭建、初始化、变更、监控集群的部署工具有强需求，可以提高小型开发团队在系统迭代阶段的效率


# 功能 #
1. 根据集群拓扑结构的规划自动搭建整套集群
2. 提供自定义配置、变更配置功能
3. 自动处理好外部系统依赖的初始化工作，如mysql系统的建库建表
4. 自动完成本系统的环境初始化工作
5. 自动生成全集群各模块的启停及状态监控脚本

# 代码结构 #
代码路径: [https://github.com/ksk0014/distributed-systems-deploy](https://github.com/ksk0014/distributed-systems-deploy)  

下载下来后会有三个目录:
  
- conf目录: 模块配置文件, machine.xxx代表集群拓扑结构规划
- bin目录: 集群部署、升级脚本
- auto-deploy-cluster: 主运行程序，模板目录

# conf说明 #
| 文件 | 说明 |
| :--- | :--- |
| cluster.conf | 搭建的所有配置,在文件中有详细注释 |
| diy.conf | 模块自定义配置，端口类的配置可以忽略，此类配置系统会自动分配得出 |
| machine.xxx | 某个模板需要搭建的机器, 每一行表示一个机器 |


# 数据结构 #
模板数据组织结构如下:

```
group = {
 "instances": [
   &instance1,
   &instance2
 ]
}

region = {
}#同group
 
#搭建的某个实例
instance = {
"name": str, #唯一标识某个搭建模块的名字
"dir_name": str, #在机器上的部署目录,同一模块在同一机器上部署多个时该值不一样
"app_type": str, #见application中的name
"on_machine": str, #机器名,与machine中的name对应
"group": int, #暂时未用
"region": int, #fileserver 的region标识
"idx": int, #该模块的第几个实例,
"idx_in_group": int, #在group中该实例的index
"machine_ref": &{machine}, #见machine数据结构
"application_ref": &{application}, #见application数据结构
"group_ref": &{group}, #见group数据结构
"region_ref": &{region}, #见region数据结构
"idx_in_region": int, #region中该实例的index
"ports": {
    "port_name": int, #port_name来源于application中的port_name,根据不同的模块而不一样
    ...
},
"region_name": str
}

#固定数据结构,数据中每个元素表示某一个模块,即一个application
applications = [
{   #一个application
    "name": "xxx|yyy|zzz",
    "dir_tmpl": str, #模板目录,一般不会用到,
    "port_names": ["xx_port", "xx_port"], #不同的模块的port_name不一样,可查看代码
    "idx": int, #一般不会用到
    "instances": [&instance], #模块的instance列表
    "group_with_name": {
         "group_name": &group, #group_name是一个int值
          ...
    },
    "region_with_name":{
        "region_name": &region, #同上
    },
    "groups": [&group], #group的列表,
    "region": [&region], #region的列表
},
{
...
}
]
 
#搭建的机器信息
machines = [
{
    "name": str, #机器标识,不一定是机器名,与instance中的on_machine对应
    "deploy__address": str, #格式为user_name@machine_host这种格式
    "deploy__dest_dir": str, #在机器上的搭建目录
    "ip": str, #机器ip
    "user_name": str, #机器用户名
    "pass": str, #机器密码
    "idx": int, #机器的index
    "instances": [&instance], #机器上搭建的instance列表
}
]
 
#几个全局变量
machine_with_name = {
    "name": &machine,
    "name2": &machine,
    ...
}
 
application_with_name = {
    "name": &application,
    ...
}
 
group_with_name = {
    "name": &group
}
 
region_with_name = {
    "name": &region
}

```

# 使用 #
部署集群:

1. 设计拓扑结构
2. 完成模块配置设定
3. bin目录下执行 install.sh, 等待集群安装完毕

更新集群:

1. 修改集群配置，及模块配置
2. bin目录下执行 upgrade.sh module_name, 等待更新完毕

集群中控:  

1. 部署完毕生成shell目录，支持模块级别的启停、存活状态、机器资源耗费的检查 




